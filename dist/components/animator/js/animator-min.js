"use strict";if("undefined"==typeof OpenLayers||!OpenLayers)throw"ERROR: OpenLayers is required for fi.fmi.metoclient.ui.animator.WmsCapabilities!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.ui=fi.fmi.metoclient.ui||{},fi.fmi.metoclient.ui.animator=fi.fmi.metoclient.ui.animator||{},fi.fmi.metoclient.ui.animator.WmsCapabilities=function(){function a(a,b,c){a&&setTimeout(function(){try{a(b,c)}catch(d){"undefined"!=typeof console&&console&&console.error("ERROR: Callback function error!")}},0)}function b(b){var c,d=[];if(!b.url)throw"ERROR: Empty URL!";var e=new OpenLayers.Format.WMSCapabilities,f={SERVICE:i,VERSION:j,REQUEST:k};OpenLayers.Request.GET({url:b.url,params:b.params||f,success:function(f){var g=f.responseXML;g&&g.documentElement||(g=f.responseText),c=e.read(g),a(b.callback,c,d)},failure:function(e){var f={};if(f[l]=e.status,f[m]=e.statusText,d.push(f),"undefined"!=typeof console&&console){var g="ERROR: Response error: ";g+="Status: "+f[l],g+=", Text: "+f[m],console.error(g)}a(b.callback,c,d)}})}function c(a,b){var c;if(b&&a&&a.capability&&a.capability.layers)for(var d=a.capability.layers,e=0;e<d.length;++e){var f=d[e];if(f&&f.name===b){c=f;break}}return c}function d(a){var b;if(a){var c=a.dimensions;if(c){var d=c.time;d&&(b=d.values)}}return b}function e(a){var b,c=d(a);if(c&&c.length){if(b=c[0],1===c.length&&void 0!==b&&null!==b){b+="";var e=b.split("/");e.length&&(b=e[0])}b=new Date(b)}return b}function f(a){var b,c=d(a);if(c&&c.length){if(b=c[c.length-1],void 0!==b&&null!==b&&1===c.length){b+="";var e=b.split("/");e.length>1&&(b=e[1])}b=new Date(b)}return b}function g(a){var b;return a&&a.capability&&a.capability.request&&a.capability.request.getcapabilities&&a.capability.request.getcapabilities.href&&(b=a.capability.request.getcapabilities.href),b}function h(c){if(!c||!c.callback){var d="ERROR: Options object and callback function in it are mandatory!";throw"undefined"!=typeof console&&console&&console.error(d),d}try{b(c)}catch(e){var f={};f[m]=e.toString(),"undefined"!=typeof console&&console&&console.error("ERROR: Get data error: "+f[m]),a(c.callback,void 0,[f])}}var i="WMS",j="1.3.0",k="GetCapabilities",l="errorCode",m="errorText";return{getData:h,getRequestUrl:g,getLayer:c,getLayerTimes:d,getBeginTime:e,getEndTime:f}}(),"undefined"==typeof OpenLayers||!OpenLayers)throw"ERROR: OpenLayers is required for fi.fmi.metoclient.ui.animator.Factory!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.ui=fi.fmi.metoclient.ui||{},fi.fmi.metoclient.ui.animator=fi.fmi.metoclient.ui.animator||{},"undefined"==typeof fi.fmi.metoclient.ui.animator.WmsCapabilities||!fi.fmi.metoclient.ui.animator.WmsCapabilities)throw"ERROR: fi.fmi.metoclient.ui.animator.WmsCapabilities is required for fi.fmi.metoclient.ui.animator.Factory!";if(fi.fmi.metoclient.ui.animator.Factory=function(){function a(a,b){if(a&&b&&b>0){var c=a.getTime();if(c!==b){var d=c%b;d&&(c-=d,a.setTime(c))}}}function b(a,b){if(a&&b&&b>0){var c=a.getTime();if(c!==b){var d=c%b;d&&(c+=b-d,a.setTime(c))}}}var c="auto",d="join";!function(){Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw"Function.prototype.bind - what is trying to be bound is not callable";var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;var f=d;return e.prototype=new f,e})}();var e=function(e){function f(){var a=[];if(H&&H.layers&&H.layers.length)for(var b=0;b<H.layers.length;++b){var c=H.layers[b];if(c){var d=c.capabilities;d&&a.push(d)}}return a}function g(){for(var a=[],b=f(),c=0;c<b.length;++c){var d=b[c];if(d&&d.url){for(var e=!1,g=0;g<a.length;++g)if(d.url===a[g]){e=!0;break}e||a.push(d.url)}}return a}function h(a,b){var c;if(a&&b)for(var d=0;d<K.length;++d){var e=K[d];if(e){var f=e.capabilities;if(f&&b===e.url){var g=fi.fmi.metoclient.ui.animator.WmsCapabilities.getLayer(f,a);if(g){c=g;break}}}}return c}function i(){if(H&&H.layers&&H.layers.length){b(M,w());for(var c=0;c<H.layers.length;++c){var d=H.layers[c];if(d)for(var e=0;e<d.args.length;++e){var f=d.args[e];if(f){var g,h=f.animation;if(h){var i=h.resolutionTime;if(void 0===i&&(i=w(),void 0===i))throw"ERROR: Animation resolution time missing!";if(h.isForecast&&(g=void 0!==h.beginTime?h.beginTime instanceof Date?new Date(h.beginTime.getTime()):new Date(h.beginTime):x(),a(g,i),void 0!==g&&(void 0===M||M.getTime()>g.getTime())&&(M=g)),h.layers)for(var j=0;j<h.layers.length;++j){var k=h.layers[j];k&&(k.isForecast||h.isForecast)&&(g=void 0!==k.beginTime?k.beginTime instanceof Date?new Date(k.beginTime.getTime()):new Date(k.beginTime):x(),a(g,i),void 0!==g&&(void 0===M||M.getTime()>g.getTime())&&(M=g))}break}}}}}}function j(d,e,f){d&&e&&(d.beginTime===c&&(d.beginTime=fi.fmi.metoclient.ui.animator.WmsCapabilities.getBeginTime(e),b(d.beginTime,f)),d.endTime===c&&(d.endTime=fi.fmi.metoclient.ui.animator.WmsCapabilities.getEndTime(e),a(d.endTime,f)))}function k(a,c){if(a&&c&&c.url&&c.layer){var e=h(c.layer,c.url);if(e){var f=a.resolutionTime;if(void 0===f&&(f=w(),void 0===f))throw"ERROR: Animation resolution time missing!";if(j(a,e,f),a.layers)for(var g=0;g<a.layers.length;++g){var i=a.layers[g];if(i&&i.layer&&(j(i,h(i.layer,c.url),f),i.beginTime===d)){if(i.beginTime=fi.fmi.metoclient.ui.animator.WmsCapabilities.getEndTime(e),void 0===i.beginTime)throw"ERROR: Animation sub-layer missing capability begin time!";i.beginTime=new Date(i.beginTime.getTime()+1),b(i.beginTime,f)}}}}}function l(){try{if(K.length&&H&&H.layers)for(var a=0;a<H.layers.length;++a){var b=H.layers[a];if(b&&b.args)for(var c=0;c<b.args.length;++c){var d=b.args[c];if(d){var e=d.animation;if(e){k(e,b.capabilities);break}}}}i()}catch(f){var g="ERROR: Configuration check failed: "+f.toString();"undefined"!=typeof console&&console&&console.error(g),I.push(g)}}function m(a,b,c){J>0&&--J,b&&K.push(b),c&&I.push.apply(I,c),0===J&&(J=-1,l(),P(a))}function n(a,b){var c=function(c,d){var e={url:b,capabilities:c};m(a,e,d)},d={url:b,callback:c};fi.fmi.metoclient.ui.animator.WmsCapabilities.getData(d)}function o(a){K=[];var b=function(b){setTimeout(function(){m(a,void 0,["ERROR: Error init capabilities: "+b.toString()])},0)},c=g();if(J=c.length,c.length)for(var d=0;d<c.length;++d)try{n(a,c[d])}catch(e){b(e)}else setTimeout(function(){m(a,void 0,[])},0)}function p(){var a;if(H){var b=H.layers;if(b)for(var c=0;c<b.length;++c){var d=b[c];if(d&&d.args)for(var e=0;e<d.args.length;++e){var f=d.args[e];if(f){var g=f.animation;if(g){(!a||void 0!==g.resolutionTime&&null!==g.resolutionTime&&a<g.resolutionTime)&&(a=g.resolutionTime);break}}}}}return a}function q(){var a;if(H){var b=H.layers;if(b)for(var c=0;c<b.length;++c){var d=b[c];if(d&&d.args)for(var e=0;e<d.args.length;++e){var f=d.args[e];if(f){var g=f.animation;if(g){if(void 0!==g.beginTime&&null!==g.beginTime){var h=g.beginTime;h instanceof Date||(h=new Date(h)),(void 0===a||h.getTime()<a.getTime())&&(a=new Date(h.getTime()))}break}}}}}return a}function r(){var a;if(H){var b=H.layers;if(b)for(var c=0;c<b.length;++c){var d=b[c];if(d&&d.args)for(var e=0;e<d.args.length;++e){var f=d.args[e];if(f){var g=f.animation;if(g){if(void 0!==g.endTime&&null!==g.endTime){var h=g.endTime;h instanceof Date||(h=new Date(h)),(void 0===a||h.getTime()>a.getTime())&&(a=new Date(h.getTime()))}break}}}}}return a}function s(){if(!C&&H&&H.map&&H.map.className){var a;if(H.map.args&&H.map.args.length>0){a=H.map.args;var b=a[0];b.theme||(b.theme=null)}C=O(H.map.className,a)}return C}function t(){if(s()&&H&&H.layers&&0===L.length)for(var c,d=H.layers,e=0;e<d.length;++e){var f=d[e];if(c=void 0,f&&f.className&&f.args){for(var g=0;g<f.args.length;++g){var h=f.args[g];if(h){var i=h.animation;if(i){void 0===i.resolutionTime&&(i.resolutionTime=w()),void 0===i.beginTime&&(i.beginTime=x()),void 0===i.endTime&&(i.endTime=y()),i.resolutionTime&&(i.beginTime instanceof Date||(i.beginTime=new Date(i.beginTime)),a(i.beginTime,i.resolutionTime),i.endTime instanceof Date||(i.endTime=new Date(i.endTime)),b(i.endTime,i.resolutionTime));break}}}c=O(f.className,f.args)}c&&L.push(c)}return L}function u(){return H?H.defaultZoomLevel:void 0}function v(){return H?H.animationFrameRate:void 0}function w(){if(void 0===D&&(D=H?H.animationResolutionTime:void 0,!D&&(D=p(),!D)))throw"ERROR: Animation configuration missing resolution time!";return D}function x(){if(void 0===E&&H&&(void 0!==H.animationDeltaToBeginTime?(E=new Date,H.animationDeltaToBeginTime?(E.setTime(E.getTime()-H.animationDeltaToBeginTime),a(E,w())):b(E,w())):(E=q(),void 0!==E&&a(E,w())),void 0===E))throw"ERROR: Animation configuration missing proper begin time!";return void 0===E?void 0:new Date(E.getTime())}function y(){if(void 0===F&&H&&(void 0!==H.animationDeltaToEndTime?(F=new Date,H.animationDeltaToEndTime?(F.setTime(F.getTime()+H.animationDeltaToEndTime),b(F,w())):a(F,w())):(F=r(),void 0!==F&&b(F,w())),void 0===F))throw"ERROR: Animation configuration missing proper end time!";return void 0===F?void 0:new Date(F.getTime())}function z(){return M}function A(){for(var a=[],b=0;b<K.length;++b)a.push(K[b].capabilities);return a}function B(a){if(!a){var b="ERROR: Factory init callback is mandatory!";throw"undefined"!=typeof console&&console&&console.error(b),b}try{J=0,I=[],o(a)}catch(c){var d=c.toString();"undefined"!=typeof console&&console&&console.error("ERROR: Factory init error: "+d),I.push(d),P(a)}}var C,D,E,F,G=this,H=e,I=[],J=0,K=[],L=[],M=new Date,N=function(a,b){var c;if(a){var d=[a];b&&(d=d.concat(b)),c=a.bind.apply(a,d)}return c},O=function(a,b){var c;if(a){var d=a.split("."),e=window||this;if(e){for(var f=0,g=d.length;g>f;f++)e=e[d[f]];"function"==typeof e&&(c=new(N(e,b)))}}return c},P=function(a){a&&setTimeout(function(){try{a(G,I)}catch(b){"undefined"!=typeof console&&console&&console.error("ERROR: Callback function error!")}},0)};this.init=B,this.getCapabilities=A,this.getMap=s,this.getLayers=t,this.getDefaultZoomLevel=u,this.getAnimationFrameRate=v,this.getAnimationResolution=w,this.getAnimationBeginDate=x,this.getAnimationEndDate=y,this.getForecastBeginDate=z};return e}(),"undefined"==typeof Raphael||!Raphael)throw"ERROR: Raphael JS is required for fi.fmi.metoclient.ui.animator.Controller!";if("undefined"==typeof jQuery||!jQuery)throw"ERROR: jQuery is required for fi.fmi.metoclient.ui.animator.Controller!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.ui=fi.fmi.metoclient.ui||{},fi.fmi.metoclient.ui.animator=fi.fmi.metoclient.ui.animator||{},fi.fmi.metoclient.ui.animator.Controller=function(){function a(a){var b=a.getHours(),c=a.getMinutes(),d=b>9?b:"0"+b;return d+=":",d+=c>9?c:"0"+c}var b=Raphael,c="Arial",d=12,e=function(e,f,g){function h(){return 50}function i(){return Math.floor(jQuery(gb.node).offset().left)}function j(){return i()+h()}function k(){nb.attr("stroke-width",0);var a=Math.floor(jQuery(nb.node).offset().left);return nb.attr("stroke-width",db.strokeWidth),a}function l(){return k()+db.sliderTipDx}function m(){var a=l()-i();0>a&&(a=0),kb.attr("width",a);var b=gb.attr("width")-a;0>b&&(b=0),lb.attr("x",kb.attr("x")+a).attr("width",b)}function n(){return ab?ab.getForecastStartTime():0}function o(){return ab?ab.getStartTime():0}function p(){return ab?ab.getEndTime():0}function q(){return ab?ab.getResolution():0}function r(){return gb.getBBox().x+h()}function s(){return gb.getBBox().y}function t(){return Math.floor(cb.width-2*h())}function u(){return Math.floor(gb.getBBox().height)}function v(){return ab&&t()?(ab.getEndTime()-ab.getStartTime())/t():1}function w(a){var b=q();return void 0!==a&&null!==a&&b&&(a+=Math.floor(b/4),a-=a%b),a}function x(a){var b=Math.floor(o()+(a-j())*v());return b<o()?b=o():b>p()&&(b=p()),b}function y(a){var b=j(),c=a-o(),d=v(),e=Math.floor(b+(d?c/d:0));return e}function z(){var b=new Date(w(x(l())));ob.attr("text",a(b))}function A(a){var b=/T-*\d+,0/;mb.forEach(function(c){var d=c.transform().toString(),e=d.match(b);if(e&&e.length){var f=parseInt(e[0].substring(1),10);c.transform(d.replace(b,"T"+(f+a)+",0"))}else c.transform("...T"+a+",0")})}function B(a){var b=Math.round(a-l()),c=j();b&&a>=c&&a<=c+t()&&(A(b),z(),m())}function C(){mb.toFront(),z()}function D(){bb.proposePause(),pb=k()}function E(a){var b=x(pb+a);bb.proposeTimeSelectionChange(b)}function F(){pb=void 0}function G(){bb.proposeNextFrame()}function H(){bb.proposePreviousFrame()}function I(a,b){return b>0?G():0>b&&H(),!1}function J(){var a=0,b=n(),c=o(),d=p();return void 0!==b?ab&&d-c&&(a=Math.floor(t()*(b-c)/(d-c))):a=t(),0>a&&(a=0),a}function K(){var a=ab?t()-J():0;return 0>a&&(a=0),a}function L(){var a=J(),b=K(),c=a+b;hb.attr("x",cb.x+h()).attr("width",c),ib.attr("x",cb.x+h()).attr("width",a),jb.attr("x",cb.x+h()+a).attr("width",b)}function M(){for(;fb.length;)fb.splice(0,1)[0].remove();var a=q();if(a)for(var b=o(),c=p(),d=r(),e=s()+u()-cb.progressCellHeight-1,f=Math.floor((c-b)/a),g=t()/f,h=0;f>h;++h){var i=_.rect(d+h*g,e,g,cb.progressCellHeight);i.attr("fill",cb.bgColor).attr("stroke-width","0"),i.node.id="animationProgressCell_"+(b+(h+1)*a),fb.push(i),jQuery(i.node).mousewheel(I)}}function N(a){for(var b,c=0;c<fb.length;++c)if(fb[c].node.id==="animationProgressCell_"+a){b=fb[c],b.attr("fill",cb.cellReadyColor);break}return b}function O(){for(;eb.length;)eb.splice(0,1)[0].remove();var b=q();if(b)for(var e,f=o(),g=p(),h=r(),i=Math.floor((g-f)/b),k=t()/i,l=0;i>=l;++l){var m=h+l*k,n=new Date(f+l*b),v=u()-(cb.height-cb.bgHeight),w=0===n.getMinutes()&&0===n.getSeconds()&&0===n.getMilliseconds();if((w||0===l||l===i)&&(v=u()/4),v){var x=s()+u(),y=_.path("M"+m+","+x+"V"+v);if(y.attr("stroke",Raphael.getRGB("white")).attr("opacity",.5),eb.push(y),jQuery(y.node).mousewheel(I),w&&i>l){var z=_.text(m+2,s()+8,a(n)).attr("text-anchor","start").attr("font-family",c).attr("font-size",d).attr("fill",Raphael.getRGB("black")),A=jQuery(z.node);A.offset().left+A.width()<=j()+t()?(eb.push(z),jQuery(z.node).mousewheel(I)):z.remove()}}e=n.getHours()}}function P(a){for(var b=a.events,c=0;c<b.length;++c){var d=b[c].time.getTime(),e=N(d);e&&e.attr("fill",cb.bgColor)}}function Q(){L(),M(),O(),C(),m(),kb.toFront(),lb.toFront()}function R(a){P(a)}function S(a){for(var b=a.events,c=0;c<b.length;++c){var d=b[c].time.getTime(),e=N(d);e&&e.attr("fill",b[c].error?cb.cellErrorColor:cb.cellLoadingColor)}}function T(a){for(var b=a.events,c=0;c<b.length;++c){var d=b[c].time.getTime(),e=N(d);e&&e.attr("fill",b[c].error?cb.cellErrorColor:cb.cellReadyColor)}}function U(){}function V(){}function W(a){P(a)}function X(a){for(var b=a.events,c=0;c<b.length;++c){var d=b[c].time.getTime();B(y(d))}}function Y(a){ab=a,a.addTimePeriodChangeListener({timePeriodChanged:function(){Q()}}),a.addTimeSelectionChangeListener({selectedTimeChanged:function(a){B(y(a))}}),a.addForecastStartTimeChangeListener({forecastStartTimeChanged:function(){L()}}),a.addAnimationEventsListener({loadAnimationStartedCb:R,loadFrameStartedCb:S,loadFrameCompleteCb:T,loadGroupProgressCb:U,loadCompleteCb:V,animationFrameContentReleasedCb:W,frameChangedCb:X}),Q()}function Z(a){bb=a}function $(){_.remove()}var _,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb=this;!function(){_=b(e,f,g),cb={radius:5,x:0,y:0,width:f,height:g-35,bgColor:Raphael.rgb(88,88,88),cellReadyColor:Raphael.rgb(148,191,119),cellErrorColor:Raphael.rgb(154,37,0),cellLoadingColor:Raphael.rgb(148,191,191),obsBgColor:Raphael.rgb(178,216,234),fctBgColor:Raphael.rgb(231,166,78)},cb.bgHeight=Math.floor(2*cb.height/3),cb.progressCellHeight=cb.height-cb.bgHeight-2,db={height:30,width:65,bgColor:Raphael.rgb(88,88,88),strokeBgColor:Raphael.rgb(191,191,191),strokeWidth:1},db.sliderTipHeight=db.height*(3/7),db.scaleX=db.width/14,db.scaleY=(db.height+db.sliderTipHeight)/7,db.sliderTipDx=Math.floor(4*db.scaleX),db.y=cb.y+cb.height-Math.floor(db.sliderTipHeight/3),eb=_.set(),fb=_.set(),gb=_.rect(cb.x,cb.y,cb.width,cb.height,cb.radius),gb.attr("stroke-width",0),gb.attr("opacity",0),hb=_.rect(cb.x+h(),cb.y,J()+K(),cb.height),hb.attr("fill",cb.bgColor),hb.attr("stroke-width",0),ib=_.rect(cb.x+h(),cb.y,J(),cb.bgHeight),ib.attr("fill",cb.obsBgColor),ib.attr("stroke-width",0),jb=_.rect(cb.x+h()+J(),cb.y,K(),cb.bgHeight),jb.attr("fill",cb.fctBgColor),jb.attr("stroke-width",0),kb=_.rect(cb.x,cb.y,h(),cb.height),kb.attr("fill",Raphael.rgb(0,0,0)).attr("opacity",0),kb.attr("stroke-width",0),kb.click(H),lb=_.rect(cb.x+f,cb.y,h(),cb.height),lb.attr("fill",Raphael.rgb(0,0,0)).attr("opacity",0),lb.attr("stroke-width",0),lb.click(G),jQuery([gb.node,hb.node,ib.node,jb.node,kb.node,lb.node]).mousewheel(I),mb=_.set(),nb=_.path("M0,2L0,7L14,7L14,2L6,2L4,0L2,2Z"),nb.attr("fill",db.bgColor),nb.attr("stroke",db.strokeBgColor),nb.attr("stroke-width",db.strokeWidth),nb.transform("S"+db.scaleX+","+db.scaleY+",0,0T0,"+db.y),ob=_.text(32,db.y+26,"00:00"),ob.attr("text-anchor","start").attr("font-family",c).attr("font-size",d),ob.attr("fill",db.strokeBgColor).attr("stroke-width",0),mb.push(nb),mb.push(ob),mb.drag(E,D,F,qb,qb,qb),z(),jQuery([nb.node,ob.node]).mousewheel(I),B(j())}(),this.setTimeModel=Y,this.setTimeController=Z,this.remove=$};return e}(),"undefined"==typeof _||!_)throw"ERROR: Lodash is required for fi.fmi.metoclient.ui.animator.Animator!";if("undefined"==typeof jQuery||!jQuery)throw"ERROR: jQuery is required for fi.fmi.metoclient.ui.animator.Animator!";if("undefined"==typeof OpenLayers||!OpenLayers)throw"ERROR: OpenLayers is required for fi.fmi.metoclient.ui.animator.Animator!";if("undefined"==typeof OpenLayers.Layer||"undefined"==typeof OpenLayers.Layer.Animation||"undefined"==typeof OpenLayers.Layer.Animation.Utils||!OpenLayers.Layer.Animation.Utils)throw"ERROR: OpenLayers.Layer.Animation.Utils is required for fi.fmi.metoclient.ui.animator.Animator!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.ui=fi.fmi.metoclient.ui||{},fi.fmi.metoclient.ui.animator=fi.fmi.metoclient.ui.animator||{},"undefined"==typeof fi.fmi.metoclient.ui.animator.Factory||!fi.fmi.metoclient.ui.animator.Factory)throw"ERROR: fi.fmi.metoclient.ui.animator.Factory is required for fi.fmi.metoclient.ui.animator.Animator!";if("undefined"==typeof fi.fmi.metoclient.ui.animator.Controller||!fi.fmi.metoclient.ui.animator.Controller)throw"ERROR: fi.fmi.metoclient.ui.animator.Controller is required for fi.fmi.metoclient.ui.animator.Animator!";fi.fmi.metoclient.ui.animator.Animator=function(){function a(a){var b;return _.isObject(a)&&_.isFunction(a.clone)&&(b=a.clone()),b}var b={events:new OpenLayers.Events(this)},c=function(){function c(a,b){b&&b.length?"undefined"!=typeof console&&console&&console.error("ERROR: Animator config init errors. Animation is not created!"):(G(a),B(),E()),X(a.callback,b)}function d(a){var b;return _.isFunction(a)&&(b=_.debounce(a,10,{maxWait:100})),b}function e(a){a&&-1===jQuery.inArray(a,U)&&(U.length||jQuery(".animatorLoadProgressbar").show(),U.push(a))}function f(a){if(a&&U.length){var b=jQuery.inArray(a,U);-1!==b&&(U.splice(b,1),U.length||jQuery(".animatorLoadProgressbar").hide())}}function g(){return M.getAnimationBeginDate()}function h(){return M.getAnimationEndDate()}function i(){return M.getAnimationResolution()}function j(){return M.getForecastBeginDate()}function k(){if(L){var a=jQuery("#"+L.playAndPauseDivId);a.length&&a.click(function(){void 0!==N?q():p()}),l()}}function l(){if(L){var a=jQuery("#"+L.playAndPauseDivId);if(a.length){var b=a.css("background-image");void 0!==N?(b=b.replace("play.png","pause.png"),a.css("background-image",b)):(b=b.replace("pause.png","play.png"),a.css("background-image",b))}}}function m(){if(void 0===O)O=g().getTime();else{var a=i();O=O+a>h().getTime()?g().getTime():O+a}b.events.triggerEvent("timechanged",{time:O})}function n(){if(void 0===O)O=g().getTime();else{var a=i();O=O-a<g().getTime()?h().getTime():O-a}b.events.triggerEvent("timechanged",{time:O})}function o(a,c){O=a instanceof Date?a.getTime():a,b.events.triggerEvent("timechanged",{time:a}),jQuery.each(c,function(b,c){c.selectedTimeChanged(a)})}function p(){void 0===N&&(N=new Date,l(),r())}function q(){void 0!==N&&(N=void 0,l())}function r(){if(void 0!==N&&M){requestAnimationFrame(r);var a=new Date;N.getTime()+M.getAnimationFrameRate()<a.getTime()&&(N=a,m())}}function s(){q(),m()}function t(){q(),n()}function u(a,b,c,d){var e=jQuery('<div class="scroll-content-item ui-widget-header"></div>');e.css("background-image","url('"+c.url+"')"),d&&(e.addClass("selectedLegend"),b.css("background-image",e.css("background-image")));var f=a.width()||2;a.append(e);var g=f+e.outerWidth(!0);a.width()<g&&a.width(g),e.click(function(){e.hasClass("selectedLegend")||(jQuery(".scroll-content-item").removeClass("selectedLegend"),e.addClass("selectedLegend"),b.css("background-image",e.css("background-image")))})}function v(){var a=jQuery(".scroll-pane"),b=jQuery(".scroll-content");b.width()<a.outerWidth(!0)&&b.width(a.outerWidth(!0));var c=jQuery(".scroll-bar").slider({slide:function(c,d){b.width()>a.width()?b.css("margin-left",Math.round(d.value/100*(a.width()-b.width()))+"px"):b.css("margin-left",0)}}),e=c.find(".ui-slider-handle").mousedown(function(){c.width(e.width())}).mouseup(function(){c.width("100%")}).append("<span class='ui-icon ui-icon-grip-dotted-vertical'></span>").wrap("<div class='ui-handle-helper-parent'></div>").parent();a.css("overflow","hidden");var f=function(){var d=a.width()-b.width();d>0&&(d=0);var e="auto"===b.css("margin-left")?0:parseInt(b.css("margin-left"),10),f=d?Math.round(100*(e/d)):0;c.slider("value",f)},g=function(){if(b.width()>a.width()){var c=b.width()+parseInt(b.css("margin-left"),10),d=a.width()-c;d>0&&b.css("margin-left",parseInt(b.css("margin-left"),10)+d+"px")}else b.css("margin-left",0)},h=function(){var d=b.width()-a.width();0>d&&(d=0);var f=d/b.width(),g=a.width()-f*a.width();c.find(".ui-slider-handle").css({width:Math.floor(g),"margin-left":-Math.floor(g/2)}),e.width(Math.floor(c.width()-g))};P=d(function(){f(),g(),h()});var i=setTimeout(function(){h(),V.splice(V.indexOf(i),1),i=void 0},10);V.push(i)}function w(){v()}function x(a,b){if(a){var c,d,e,f,g,h,i=jQuery("#"+a);i.empty();var j=0;for(c=0;c<b.length;++c)if(e=b[c],e.getVisibility()&&e.getLegendInfo)for(f=e.getLegendInfo(),d=0;d<f.length;++d)g=f[d],g.hasLegend&&++j;if(j)if(1===j){for(i.removeClass("animatorLegendNoLegend"),L.animationDivId&&jQuery("#"+L.animationDivId).removeClass("animatorAnimationNoLegend"),h=jQuery('<div class="animatorLegendView animatorLegendViewOne"></div>'),i.append(h),c=0;c<b.length;++c)if(e=b[c],e.getVisibility()&&e.getLegendInfo)for(f=e.getLegendInfo(),d=0;d<f.length;++d)if(g=f[d],g.hasLegend){h.css("background-image","url('"+g.url+"')");break}}else{i.removeClass("animatorLegendNoLegend"),L.animationDivId&&jQuery("#"+L.animationDivId).removeClass("animatorAnimationNoLegend");var k=jQuery('<div class="animatorLegendThumbnails"></div>');k.append('<div class="scroll-pane ui-widget ui-widget-header ui-corner-all"><div class="scroll-content"></div><div class="scroll-bar-wrap ui-widget-content ui-corner-bottom"><div class="scroll-bar"></div></div></div>'),i.append(k),h=jQuery('<div class="animatorLegendView"></div>'),i.append(h);var l=jQuery(".scroll-content"),m=!1;for(c=0;c<b.length;++c)if(e=b[c],e.getVisibility()&&e.getLegendInfo)for(f=e.getLegendInfo(),d=0;d<f.length;++d)g=f[d],g.hasLegend&&(u(l,h,g,!m),m=!0);w()}else i.addClass("animatorLegendNoLegend"),L.animationDivId&&jQuery("#"+L.animationDivId).addClass("animatorAnimationNoLegend")}else L.animationDivId&&jQuery("#"+L.animationDivId).addClass("animatorAnimationNoLegend")}function y(a){if(L.legendDivId)for(var b,c=function(){void 0===b&&(b=setTimeout(function(){x(L.legendDivId,a),V.splice(V.indexOf(b),1),b=void 0},100),V.push(b))},d={visibilitychanged:c,added:c,removed:c},e=0;e<a.length;++e){var f=a[e];f.events&&f.getLegendInfo&&f.events.on(d)}}function z(a,b,c){if(a){var d;b&&(d={div:OpenLayers.Util.getElement(b)});var e=new OpenLayers.Control.LayerSwitcher(d);a.addControl(e),c||e.minimizeControl()}}function A(a,c){for(var d=0;d<c.length;++d){var e=c[d];e.registerController&&e.registerController(b.events),e.events&&e.events.on(W),a.addLayer(e)}}function B(){if(L.animationDivId){var a=jQuery('<div class="animatorLoadProgressbar"></div>');jQuery("#"+L.animationDivId).append(a),a.progressbar({value:!1}),a.hide()}if(L.mapDivId){var b=M.getMap();if(b){b.render(L.mapDivId);var c=M.getLayers();c&&(y(c),A(b,c)),b.setCenter(b.getCenter(),M.getDefaultZoomLevel()),z(b,L.layerSwitcherDivId,L.maximizeSwitcher)}}}function C(){Q&&(Q.remove(),Q=void 0,R=void 0)}function D(a,b,c){var d=new fi.fmi.metoclient.ui.animator.Controller(a[0],a.width(),a.height());return d.setTimeModel(b),d.setTimeController(c),d}function E(){if(!L||!L.controllerDivId||!L.playAndPauseDivId)throw"ERROR: Options or properties missing for controller!";if(void 0!==g()&&void 0!==h()){var a="#"+L.controllerDivId,b=jQuery(a);if(b.length){(new Date).getTime();var c=g().getTime(),e=h().getTime(),f=j().getTime();f>e&&(f=void 0);var l=[],m=[],n=[],p=[],r={getStartTime:function(){return c},getEndTime:function(){return e},getResolution:function(){return i()},getForecastStartTime:function(){return f},addTimePeriodChangeListener:function(a){l.push(a)},addTimeSelectionChangeListener:function(a){m.push(a)},addAnimationEventsListener:function(a){T.push(a)},addForecastStartTimeChangeListener:function(a){n.push(a)},addTickIntervalChangeListener:function(a){p.push(a)}},u={proposeTimePeriodChange:function(){},proposeTimeSelectionChange:function(a){a>=c&&e>=a&&(a-=a%i(),o(a,m))},proposeNextFrame:function(){s()},proposePreviousFrame:function(){t()},proposePause:function(){q()}};Q=D(b,r,u);var v=b.width();R=d(function(){var c=jQuery(a).width();c!==v&&(v=c,Q.remove(),Q=D(b,r,u))}),k()}}}function F(){L&&(L.animatorContainerDivId?jQuery("#"+L.animatorContainerDivId+" > .animator").remove():(L.animationDivId&&jQuery("#"+L.animationDivId).remove(),L.mapDivId&&jQuery("#"+L.mapDivId).remove(),L.layerSwitcherDivId&&jQuery("#"+L.layerSwitcherDivId).remove(),L.controllerDivId&&jQuery("#"+L.controllerDivId).remove(),L.playAndPauseDivId&&jQuery("#"+L.playAndPauseDivId).remove(),L.logoDivId&&jQuery("#"+L.logoDivId).remove(),L.legendDivId&&jQuery("#"+L.legendDivId).remove()))}function G(a){if(a&&a.animatorContainerDivId){var b=jQuery('<div class="animator"><div class="animatorAnimation" id="animatorAnimationId"><div class="animatorMap" id="animatorMapId"><div class="animatorLogo" id="animatorLogoId"></div><div class="animatorPlayAndPause" id="animatorPlayAndPauseId"></div></div><div class="animatorController" id="animatorControllerId"></div><div class="animatorLayerSwitcher" id="animatorLayerSwitcherId"></div></div><div class="animatorLegend" id="animatorLegendId"></div></div>');jQuery("#"+a.animatorContainerDivId).append(b),a.animationDivId="animatorAnimationId",a.mapDivId="animatorMapId",a.layerSwitcherDivId="animatorLayerSwitcherId",a.controllerDivId="animatorControllerId",a.playAndPauseDivId="animatorPlayAndPauseId",a.logoDivId="animatorLogoId",a.legendDivId="animatorLegendId"}}function H(){if(L&&!L.callback){var a="ERROR: Animator init options.callback is mandatory if getConfig is used!";throw"undefined"!=typeof console&&console&&console.error(a),a}return M}function I(){if(jQuery(window).resize(),M){var a=M.getMap();a&&a.updateSize()}}function J(){if(M){var a=M.getMap();a&&a.destroy()}for(;V.length;)clearTimeout(V.pop());T=[],U=[],N=void 0,O=void 0,P=void 0,F(),C(),M=void 0,L=void 0}function K(b){if(!L&&b)try{L=b,M=new fi.fmi.metoclient.ui.animator.Factory(_.cloneDeep(b.config||fi.fmi.metoclient.ui.animator.Config,a)),M.init(function(a,d){c(b,d)})}catch(d){var e=d.toString();"undefined"!=typeof console&&console&&console.error("ERROR: Animator init error: "+e),X(b.callback,[e])}}var L,M,N,O,P,Q,R,S=this,T=[],U=[],V=[],W={scope:S,animationloadstarted:void 0,frameloadstarted:void 0,frameloadcomplete:void 0,animationloadgroupprogress:void 0,animationloadcomplete:void 0,animationframecontentreleased:void 0,framechanged:void 0};W.animationloadstarted=function(a){e(a.layer),q(),jQuery.each(T,function(b,c){c.loadAnimationStartedCb(a)})},W.frameloadstarted=function(a){jQuery.each(T,function(b,c){c.loadFrameStartedCb(a)})},W.frameloadcomplete=function(a){jQuery.each(T,function(b,c){c.loadFrameCompleteCb(a)})},W.animationloadgroupprogress=function(a){jQuery.each(T,function(b,c){c.loadGroupProgressCb(a)})},W.animationloadcomplete=function(a){f(a.layer),p(),jQuery.each(T,function(b,c){c.loadCompleteCb(a)})},W.animationframecontentreleased=function(a){f(a.layer),jQuery.each(T,function(b,c){c.animationFrameContentReleasedCb(a)})},W.framechanged=function(a){jQuery.each(T,function(b,c){c.frameChangedCb(a)})},jQuery(window).resize(function(){P&&P(),R&&R()});var X=function(a,b){a&&setTimeout(function(){try{a(S,b)}catch(c){"undefined"!=typeof console&&console&&console.error("ERROR: Callback function error!")}},0)};this.init=K,this.reset=J,this.refresh=I,this.getConfig=H};return c}();